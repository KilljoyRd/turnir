<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All In Capone Club ‚Äî —É—á—ë—Ç —Ç—É—Ä–Ω–∏—Ä–∞</title>
  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    :root{
      --bg:#0b0b0b;
      --card:#141414;
      --card2:#101010;
      --border:#2b2b2b;
      --text:#f2f2f2;
      --muted:#bdbdbd;
      --gold:#FFC400;
      --gold2:#FFB000;
      --danger:#4a1616;
      --danger2:#6a1d1d;
      --row:#121212;
      --row2:#151515;
      --shadow:0 10px 30px rgba(0,0,0,.55);
      --radius:18px;
      --btnH:44px;
      --gap:18px;
    }

    body{
      margin:0;
      background:
        radial-gradient(ellipse at top, rgba(255,196,0,.08), transparent 42%),
        radial-gradient(ellipse at bottom, rgba(255,196,0,.05), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 40px;
    }

    /* Top bar (mascot + club name left, title center/right) */
    .topbar{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 0 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .mascotWrap{
      width:54px;
      height:54px;
      border-radius:14px;
      border:1px solid rgba(255,196,0,.35);
      background:rgba(255,196,0,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
      box-shadow:0 0 20px rgba(255,196,0,.08);
    }
    .mascotWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .brandText{
      min-width:0;
      line-height:1.1;
    }
    .clubName{
      font-weight:900;
      letter-spacing:.2px;
      color:var(--gold);
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .clubSub{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .headerRight{
      margin-left:auto;
      min-width:0;
      text-align:right;
    }
    .headerRight h1{
      margin:0 0 6px;
      font-size:clamp(18px,2.2vw,28px);
      font-weight:900;
      color:var(--gold);
      letter-spacing:.3px;
    }
    .headerRight .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .divider{
      height:1px;
      background:rgba(255,196,0,.55);
      box-shadow:0 0 18px rgba(255,196,0,.18);
      margin:6px 0 0;
    }

    /* MAIN LAYOUT ‚Äî hard anti-overlap */
    .mainGrid{
      display:grid;
      grid-template-columns: minmax(360px, 480px) minmax(0, 1fr);
      gap:var(--gap);
      align-items:start;
      margin-top:18px;
      width:100%;
    }
    .leftCol,.rightCol{ width:100%; min-width:0; }
    /* critical: prevent content from forcing grid item min-width:auto */
    .rightCol{ min-width:0; }

    @media (max-width:1000px){
      .topbar{ flex-wrap:wrap; }
      .headerRight{ text-align:left; margin-left:0; width:100%; }
      .mainGrid{ grid-template-columns:1fr; }
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 35%), var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      min-width:0; /* critical */
    }
    .card + .card{ margin-top:14px; }

    .cardTitle{
      color:var(--gold);
      font-weight:900;
      letter-spacing:.2px;
      margin:0 0 12px;
      font-size:18px;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:end;
      flex-wrap:wrap;
      min-width:0;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      letter-spacing:.2px;
    }
    input[type="text"],input[type="number"],select{
      width:100%;
      height:42px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #2d2d2d;
      background:#1b1b1b;
      color:var(--text);
      outline:none;
      min-width:0;
    }
    input::placeholder{ color:#7f7f7f; }
    .field{ flex:1 1 180px; min-width:160px; }
    .field.small{ flex:0 0 170px; }

    .explain{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Buttons */
    .btn{
      height:var(--btnH);
      border-radius:12px;
      border:1px solid transparent;
      padding:0 14px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnPrimary{ background:var(--gold); color:#111; border-color:rgba(255,196,0,.9); }
    .btnPrimary:hover{ background:var(--gold2); }
    .btnSecondary{ background:transparent; color:var(--gold); border-color:rgba(255,196,0,.85); }
    .btnSecondary:hover{ background:rgba(255,196,0,.08); }
    .btnDanger{ background:var(--danger); color:#fff; border-color:rgba(255,255,255,.08); }
    .btnDanger:hover{ background:var(--danger2); }
    .btnWide{ width:100%; }

    .btnGrid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .btnGrid2{ grid-template-columns:1fr; }
    }

    /* Stats */
    .statsGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:520px){
      .statsGrid{ grid-template-columns:1fr; }
    }
    .stat{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--card2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      min-height:74px;
      min-width:0;
    }
    .stat .val{ font-size:20px; font-weight:900; color:var(--gold); margin-bottom:4px; }
    .stat .lbl{ font-size:12px; color:var(--muted); }

    /* Table wrapper ‚Äî critical for no overlap */
    .tableCard{ padding:12px 12px 10px; }
    .tableWrap{
      width:100%;
      overflow-x:auto;    /* critical */
      overflow-y:hidden;
      min-width:0;        /* critical */
      border-radius:14px;
      border:1px solid var(--border);
      background:#0f0f0f;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:720px;    /* forces internal scroll instead of breaking layout */
    }
    .entriesTable table{ min-width:520px; }

    thead th{
      background:var(--gold);
      color:#111;
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.6px;
      padding:10px;
      border-bottom:1px solid rgba(0,0,0,.25);
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      color:var(--text);
      background:var(--row);
      vertical-align:top;
    }
    tbody tr:nth-child(even) td{ background:var(--row2); }
    tbody tr:hover td{ background:rgba(255,196,0,.08); }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--text);
      white-space:nowrap;
    }
    .pillCome{ background:rgba(16,34,20,.65); border-color:rgba(60,170,90,.18); }
    .pillPaid{ background:rgba(17,51,31,.75); border-color:rgba(60,170,90,.22); }
    .pillOut{ opacity:.92; }

    .actionsRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin:10px 0 14px;
    }
    .actionsRow .btn{ flex:1 1 240px; }

    /* Player row controls */
    .koInput{
      width:72px;
      height:34px;
      border-radius:10px;
      border:1px solid #2d2d2d;
      background:#1b1b1b;
      color:var(--text);
      padding:6px 8px;
    }
    .miniBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtn{
      height:30px;
      padding:0 10px;
      border-radius:10px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(255,196,0,.8);
      color:var(--gold);
      background:transparent;
      cursor:pointer;
      transition:.12s ease;
      white-space:nowrap;
    }
    .miniBtn:hover{ background:rgba(255,196,0,.10); }
    .miniBtnDanger{
      border-color:rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#eee;
    }
    .miniBtnDanger:hover{ background:rgba(255,255,255,.10); }

    .outRow td{ opacity:.86; }
    .footer{
      text-align:center;
      color:#8b8b8b;
      font-size:12px;
      margin-top:18px;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(920px, 100%);
      background:#0f0f0f;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.7);
      padding:16px;
    }
    .modalTop{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .modalTitle{
      color:var(--gold);
      font-weight:900;
      font-size:18px;
      margin:0;
    }
    .modalBody{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      min-width:0;
    }
    @media (max-width:760px){
      .modalBody{ grid-template-columns:1fr; }
    }
    textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      border-radius:14px;
      border:1px solid #2d2d2d;
      background:#141414;
      color:var(--text);
      padding:12px;
      outline:none;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;
      line-height:1.35;
    }
    .preview{
      border-radius:14px;
      border:1px solid #2d2d2d;
      background:#141414;
      padding:12px;
      min-height:260px;
      overflow:auto;
      font-size:12px;
      color:var(--text);
      white-space:pre-wrap;
    }
    .modalBottom{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .checkRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }

    /* Small ‚Äúflash‚Äù for search */
    tr.flash td{ outline:2px solid rgba(255,196,0,.55); outline-offset:-2px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="mascotWrap" title="All In Capone Club">
          <img src="./assets/mascot.png" alt="Mascot" onerror="this.style.display='none'; this.parentElement.textContent='üé©'; this.parentElement.style.color='#FFC400'; this.parentElement.style.fontSize='24px';" />
        </div>
        <div class="brandText">
          <div class="clubName">All In Capone Club</div>
          <div class="clubSub">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        </div>
      </div>

      <div class="headerRight">
        <h1>–ü–æ—Å–∞–¥–∫–∞, re-entry –∏ —É—á—ë—Ç —Ç—É—Ä–Ω–∏—Ä–∞</h1>
        <p class="sub">–¢–∞–ø –ø–æ —Å—Ç—Ä–æ–∫–µ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å. –í —Ç–∞–±–ª–∏—Ü–µ –≤—Ö–æ–¥–æ–≤: ¬´‚Äî ‚Üí —Å—Ç–µ–∫ –≤—ã–¥–∞–Ω ‚Üí –æ–ø–ª–∞—á–µ–Ω–æ ‚Üí ‚Äî¬ª. –í —Ç–∞–±–ª–∏—Ü–µ –∏–≥—Ä–æ–∫–æ–≤: ¬´‚Äî ‚Üí –ø—Ä–∏—à—ë–ª ‚Üí –æ–ø–ª–∞—á–µ–Ω–æ ‚Üí ‚Äî¬ª.</p>
      </div>
    </div>

    <div class="divider"></div>

    <main class="mainGrid">
      <!-- LEFT -->
      <section class="leftCol">
        <div class="card">
          <h2 class="cardTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–≥—Ä–æ–∫–∏</h2>

          <div class="row">
            <div class="field">
              <label for="modeSelect">–¢–∏–ø —Ç—É—Ä–Ω–∏—Ä–∞</label>
              <select id="modeSelect">
                <option value="standard">–û–±—ã—á–Ω—ã–π</option>
                <option value="cascade">CASCADE K.O.</option>
                <option value="bloodhunter">BLOOD HUNTER K.O.</option>
              </select>
            </div>

            <div class="field" id="cascadePhaseWrap" style="display:none;">
              <label for="cascadePhaseSelect">–§–∞–∑–∞ (CASCADE)</label>
              <select id="cascadePhaseSelect">
                <option value="late">–î–æ –∫–æ–Ω—Ü–∞ –ø–æ–∑–¥–Ω–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (+50 –∑–∞ KO)</option>
                <option value="after">–ü–æ—Å–ª–µ –ø–æ–∑–¥–Ω–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (+100 –∑–∞ KO)</option>
                <option value="final">–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª (+200 –∑–∞ KO)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="field small">
              <label for="playerNum">‚Ññ –∏–≥—Ä–æ–∫–∞</label>
              <input id="playerNum" type="number" min="1" placeholder="‚Ññ" />
            </div>
            <div class="field">
              <label for="playerName">–ù–∏–∫ / –ò–º—è –∏–≥—Ä–æ–∫–∞</label>
              <input id="playerName" type="text" placeholder="–ù–∏–∫ / –ò–º—è" />
            </div>
          </div>

          <div class="btnGrid2">
            <button class="btn btnPrimary" id="btnAddPlayer">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
            <button class="btn btnSecondary" id="btnBulkOpen">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–∫–æ–º</button>
            <button class="btn btnSecondary" id="btnExportPlayersTxt">–≠–∫—Å–ø–æ—Ä—Ç –∏–≥—Ä–æ–∫–æ–≤ (.txt)</button>
            <button class="btn btnSecondary" id="btnImportPlayersTxt">–ò–º–ø–æ—Ä—Ç –∏–≥—Ä–æ–∫–æ–≤ (.txt)</button>
          </div>
          <input type="file" id="fileImportPlayers" accept=".txt" style="display:none;" />

          <div class="explain">
            –ü—É–ª –æ—á–∫–æ–≤ = (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã + –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ re-entry) √ó <b style="color:var(--gold);">120</b>.<br>
            –û—á–∫–∏ –∑–∞ –º–µ—Å—Ç–æ –ø–æ–ª—É—á–∞—é—Ç –¢–û–ü-18. KO-–æ—á–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º–µ—Å—Ç–∞.
          </div>
        </div>

        <div class="card">
          <h2 class="cardTitle">–ò–º–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (.txt)</h2>
          <button class="btn btnSecondary btnWide" id="btnImportResultsTxt">–ó–∞–≥—Ä—É–∑–∏—Ç—å TXT</button>
          <input type="file" id="fileImportResults" accept=".txt" style="display:none;" />
          <div class="explain">
            –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ TXT, —Ä–∞–Ω–µ–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∏–≥—Ä–æ–∫–æ–≤.
          </div>
        </div>

        <div class="card">
          <h2 class="cardTitle">–ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
          <div class="statsGrid">
            <div class="stat">
              <div class="val" id="statPool">0</div>
              <div class="lbl">–û—á–∫–∏ –≤ –ø—É–ª–µ</div>
            </div>
            <div class="stat">
              <div class="val" id="statEntries">0</div>
              <div class="lbl">–í—Ö–æ–¥–æ–≤</div>
            </div>
            <div class="stat">
              <div class="val" id="statRe">0</div>
              <div class="lbl">Re-entry</div>
            </div>
            <div class="stat">
              <div class="val" id="statTotal">0</div>
              <div class="lbl">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            </div>
          </div>
          <div class="explain" id="statFormula">
            (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã + –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ re-entry) √ó 120
          </div>
        </div>

        <div class="card">
          <h2 class="cardTitle">–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞</h2>
          <div class="row">
            <div class="field">
              <label for="searchInput">–ù–∞–π—Ç–∏ –ø–æ –Ω–∏–∫—É –∏–ª–∏ ‚Ññ</label>
              <input id="searchInput" type="text" placeholder="25 –∏–ª–∏ nick" />
            </div>
            <button class="btn btnSecondary" id="btnSearch">–ù–∞–π—Ç–∏</button>
          </div>
          <div class="explain">–ü–æ–∏—Å–∫ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç —Ç–∞–±–ª–∏—Ü—É –∏–≥—Ä–æ–∫–æ–≤ —Å–ø—Ä–∞–≤–∞ –¥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.</div>
        </div>

        <div class="card tableCard entriesTable">
          <h2 class="cardTitle">–í—Ö–æ–¥—ã –∏ Re-entry</h2>
          <div class="tableWrap">
            <table id="entriesTable">
              <thead>
                <tr>
                  <th style="width:70px;">‚Ññ</th>
                  <th>–ò–≥—Ä–æ–∫</th>
                  <th style="width:120px;">–¢–∏–ø</th>
                  <th style="width:170px;">–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody id="entriesTbody"></tbody>
            </table>
          </div>
          <div class="explain">
            –¢–∞–ø –ø–æ —Å—Ç—Ä–æ–∫–µ: <b>‚Äî ‚Üí —Å—Ç–µ–∫ –≤—ã–¥–∞–Ω ‚Üí –æ–ø–ª–∞—á–µ–Ω–æ ‚Üí ‚Äî</b>. –í –ø—É–ª –æ—á–∫–æ–≤ –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ <b>–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</b> –∑–∞–ø–∏—Å–∏.
          </div>
        </div>

        <div class="card">
          <h2 class="cardTitle">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h2>
          <div class="explain" style="border-top:1px dashed rgba(255,196,0,.35); padding-top:12px;">
            <b style="color:var(--gold);">–ö–∞–∫ –Ω–∞—á–∏—Å–ª–∏—Ç—å –æ—á–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:</b>
            <ol style="margin:10px 0 10px 18px; padding:0; color:var(--muted);">
              <li>–û—Ç–º–µ—Ç—å—Ç–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã –∏ re-entry (–≤ —Ç–∞–±–ª–∏—Ü–µ ¬´–í—Ö–æ–¥—ã –∏ Re-entry¬ª).</li>
              <li>–£–∫–∞–∂–∏—Ç–µ KO —É –∏–≥—Ä–æ–∫–æ–≤ (–≤ —Ç–∞–±–ª–∏—Ü–µ —Å–ø—Ä–∞–≤–∞).</li>
              <li>–û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ª–µ—Ç—ã –∫–Ω–æ–ø–∫–æ–π ¬´–ê–£–¢¬ª.</li>
              <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∏–≥—Ä–µ –æ—Å—Ç–∞–ª—Å—è <b>1</b> –∏–≥—Ä–æ–∫.</li>
              <li>–ù–∞–∂–º–∏—Ç–µ <b>¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –æ—á–∫–∏¬ª</b>.</li>
            </ol>
            <div style="margin-top:10px; padding:10px 12px; border-radius:14px; background:rgba(255,196,0,.08); border:1px solid rgba(255,196,0,.22);">
              ‚ö†Ô∏è <b style="color:var(--gold);">–î–æ –Ω–∞–∂–∞—Ç–∏—è</b> –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—á–∫–∏ <b>–ù–ï</b> —Å—á–∏—Ç–∞—é—Ç—Å—è.
            </div>
            <div style="margin-top:10px;">–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <b>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (.txt)</b> ‚Äî –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ –∞—Ä—Ö–∏–≤–∞.</div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="rightCol">
        <div class="card">
          <h2 class="cardTitle">–ò–≥—Ä–æ–∫–∏</h2>

          <div class="actionsRow">
            <button class="btn btnPrimary" id="btnFinalize">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –æ—á–∫–∏</button>
            <button class="btn btnSecondary" id="btnExportResultsTxt" disabled>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (.txt)</button>
            <button class="btn btnDanger" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
          </div>

          <div class="tableWrap">
            <table id="playersTable">
              <thead>
                <tr>
                  <th style="width:70px;">‚Ññ</th>
                  <th>–ò–≥—Ä–æ–∫</th>
                  <th style="width:140px;">–°—Ç–∞—Ç—É—Å</th>
                  <th style="width:110px;">KO</th>
                  <th style="width:170px;">–ò—Ç–æ–≥</th>
                  <th style="width:320px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="playersTbody"></tbody>
            </table>
          </div>

          <div class="explain" style="margin-top:10px;">
            –¢–∞–ø –ø–æ —Å—Ç—Ä–æ–∫–µ –∏–≥—Ä–æ–∫–∞ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å: <b>‚Äî ‚Üí –ø—Ä–∏—à—ë–ª ‚Üí –æ–ø–ª–∞—á–µ–Ω–æ ‚Üí ‚Äî</b>.
            –ö–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º/KO –Ω–µ –º–µ–Ω—è—é—Ç —Å—Ç–∞—Ç—É—Å.
          </div>
        </div>

        <div class="footer">¬© All In Capone Club ¬∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
      </section>
    </main>
  </div>

  <!-- Bulk modal -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <h3 class="modalTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ —Å–ø–∏—Å–∫–æ–º</h3>
        <button class="btn btnSecondary" id="btnModalClose" style="height:38px;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modalBody">
        <div>
          <label>–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ (–ø–æ –æ–¥–Ω–æ–º—É –∏–≥—Ä–æ–∫—É –≤ —Å—Ç—Ä–æ–∫–µ)</label>
          <textarea id="bulkTextarea" placeholder="–ü—Ä–∏–º–µ—Ä—ã:
25 –Æ—Ä–∏—á
12, Karavan
7 - Ame
14: Scouser
33"></textarea>

          <div class="checkRow">
            <input type="checkbox" id="chkOverwrite" />
            <label for="chkOverwrite" style="margin:0; font-size:12px;">–ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏–º—è, –µ—Å–ª–∏ –Ω–æ–º–µ—Ä —É–∂–µ –µ—Å—Ç—å</label>
          </div>
        </div>

        <div>
          <label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</label>
          <div class="preview" id="bulkPreview">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å–ª–µ–≤–∞ ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.</div>
        </div>
      </div>

      <div class="modalBottom">
        <button class="btn btnSecondary" id="btnBulkCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btnPrimary" id="btnBulkApply">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const LS_KEY = "aicc_tournament_state_static_v2";
      const ENTRY_POINTS = 120;

      const TOP18_PERCENTS = [
        25.0, 13.1, 9.5, 7.5, 6.3, 5.5, 4.8, 4.3, 3.9,
        2.6, 2.5, 2.4, 2.3, 2.2, 2.1, 2.1, 2.0, 1.9
      ];

      // status: 0 '-', 1 '–ø—Ä–∏—à—ë–ª/—Å—Ç–µ–∫ –≤—ã–¥–∞–Ω', 2 '–æ–ø–ª–∞—á–µ–Ω–æ'
      const PLAYER_STATUS_LABEL = s => s===2 ? "–æ–ø–ª–∞—á–µ–Ω–æ" : (s===1 ? "–ø—Ä–∏—à—ë–ª" : "‚Äî");
      const ENTRY_STATUS_LABEL  = s => s===2 ? "–æ–ø–ª–∞—á–µ–Ω–æ" : (s===1 ? "—Å—Ç–µ–∫ –≤—ã–¥–∞–Ω" : "‚Äî");

      const modeSelect = document.getElementById("modeSelect");
      const cascadePhaseWrap = document.getElementById("cascadePhaseWrap");
      const cascadePhaseSelect = document.getElementById("cascadePhaseSelect");

      const playerNum = document.getElementById("playerNum");
      const playerName = document.getElementById("playerName");

      const btnAddPlayer = document.getElementById("btnAddPlayer");
      const btnBulkOpen = document.getElementById("btnBulkOpen");
      const btnExportPlayersTxt = document.getElementById("btnExportPlayersTxt");
      const btnImportPlayersTxt = document.getElementById("btnImportPlayersTxt");
      const fileImportPlayers = document.getElementById("fileImportPlayers");

      const btnImportResultsTxt = document.getElementById("btnImportResultsTxt");
      const fileImportResults = document.getElementById("fileImportResults");

      const statPool = document.getElementById("statPool");
      const statEntries = document.getElementById("statEntries");
      const statRe = document.getElementById("statRe");
      const statTotal = document.getElementById("statTotal");
      const statFormula = document.getElementById("statFormula");

      const searchInput = document.getElementById("searchInput");
      const btnSearch = document.getElementById("btnSearch");

      const entriesTbody = document.getElementById("entriesTbody");
      const playersTbody = document.getElementById("playersTbody");

      const btnFinalize = document.getElementById("btnFinalize");
      const btnExportResultsTxt = document.getElementById("btnExportResultsTxt");
      const btnReset = document.getElementById("btnReset");

      const modalOverlay = document.getElementById("modalOverlay");
      const btnModalClose = document.getElementById("btnModalClose");
      const btnBulkCancel = document.getElementById("btnBulkCancel");
      const btnBulkApply = document.getElementById("btnBulkApply");
      const bulkTextarea = document.getElementById("bulkTextarea");
      const bulkPreview = document.getElementById("bulkPreview");
      const chkOverwrite = document.getElementById("chkOverwrite");

      const state = loadState() || newState();

      function newState(){
        return {
          mode: "standard",          // standard | cascade | bloodhunter
          cascadePhase: "late",      // late | after | final
          players: [],               // {num,name,status,ko,outIndex,place,placePoints,koPoints,totalPoints}
          entries: [],               // {id,num,type:'entry'|'re',status}
          outCounter: 0,
          finalized: false
        };
      }

      function uid(){
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }

      function saveState(){
        try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
      }
      function loadState(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return null;
          return JSON.parse(raw);
        }catch(e){ return null; }
      }

      function syncModeUI(){
        modeSelect.value = state.mode;
        cascadePhaseSelect.value = state.cascadePhase;
        cascadePhaseWrap.style.display = (state.mode === "cascade") ? "" : "none";
      }

      modeSelect.addEventListener("change", ()=>{
        state.mode = modeSelect.value;
        recomputeAllPoints(true);
        saveState();
        render();
      });

      cascadePhaseSelect.addEventListener("change", ()=>{
        state.cascadePhase = cascadePhaseSelect.value;
        recomputeAllPoints(true);
        saveState();
        render();
      });

      btnAddPlayer.addEventListener("click", ()=>{
        const num = parseInt(playerNum.value,10);
        const name = (playerName.value||"").trim();

        if(!num || num<=0){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞."); playerNum.focus(); return; }
        if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫/–∏–º—è –∏–≥—Ä–æ–∫–∞."); playerName.focus(); return; }
        if(state.players.some(p=>p.num===num)){ alert("–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."); return; }

        addPlayer(num, name);
        playerNum.value=""; playerName.value="";
        playerNum.focus();
        saveState();
        render();
      });

      function addPlayer(num,name){
        state.players.push({
          num, name,
          status:0,
          ko:0,
          outIndex:null,
          place:null,
          placePoints:0,
          koPoints:0,
          totalPoints:0
        });
        state.entries.push({ id:uid(), num, type:"entry", status:0 });
      }

      // Bulk modal
      btnBulkOpen.addEventListener("click", ()=> openModal(true));
      btnModalClose.addEventListener("click", ()=> openModal(false));
      btnBulkCancel.addEventListener("click", ()=> openModal(false));
      modalOverlay.addEventListener("click", (e)=>{ if(e.target===modalOverlay) openModal(false); });

      function openModal(open){
        modalOverlay.style.display = open ? "flex" : "none";
        modalOverlay.setAttribute("aria-hidden", open ? "false" : "true");
        if(open){
          bulkTextarea.value="";
          chkOverwrite.checked=false;
          bulkPreview.textContent="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å–ª–µ–≤–∞ ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.";
          setTimeout(()=> bulkTextarea.focus(), 50);
        }
      }

      function parseBulkLines(text){
        const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const out=[];
        for(const line of lines){
          const m = line.match(/^(\d+)\s*(?:[,:\-]\s*|\s+)?(.+)?$/);
          if(!m) continue;
          const num = parseInt(m[1],10);
          let name = (m[2]||"").trim();
          if(!name) name = `Player #${num}`;
          out.push({num,name});
        }
        return out;
      }

      function updateBulkPreview(){
        const items = parseBulkLines(bulkTextarea.value);
        if(items.length===0){ bulkPreview.textContent="–ù–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫."; return; }
        const overwrite = chkOverwrite.checked;
        const lines = items.slice(0,200).map(x=>{
          const exists = state.players.some(p=>p.num===x.num);
          const mark = exists ? (overwrite ? "–æ–±–Ω–æ–≤–∏—Ç" : "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç") : "–¥–æ–±–∞–≤–∏—Ç";
          return `${x.num} ‚Äî ${x.name}  [${mark}]`;
        });
        bulkPreview.textContent = lines.join("\n") + (items.length>200 ? "\n‚Ä¶(–µ—â—ë —Å—Ç—Ä–æ–∫–∏ —Å–∫—Ä—ã—Ç—ã)" : "");
      }

      bulkTextarea.addEventListener("input", updateBulkPreview);
      chkOverwrite.addEventListener("change", updateBulkPreview);

      btnBulkApply.addEventListener("click", ()=>{
        const items = parseBulkLines(bulkTextarea.value);
        if(items.length===0){ alert("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω."); return; }
        const overwrite = chkOverwrite.checked;
        let added=0, updated=0, skipped=0;

        for(const it of items){
          const p = state.players.find(p=>p.num===it.num);
          if(p){
            if(overwrite){ p.name=it.name; updated++; }
            else skipped++;
          }else{
            addPlayer(it.num, it.name);
            added++;
          }
        }

        saveState();
        render();
        openModal(false);
        alert(`–ì–æ—Ç–æ–≤–æ. –î–æ–±–∞–≤–ª–µ–Ω–æ: ${added}. –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated}. –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skipped}.`);
      });

      // Export/Import players TXT
      btnExportPlayersTxt.addEventListener("click", ()=>{
        const sorted=[...state.players].sort((a,b)=>a.num-b.num);
        const lines=[];
        lines.push("–°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í");
        lines.push("");
        lines.push("–§–æ—Ä–º–∞—Ç: ‚Ññ –ø—Ä–æ–±–µ–ª –ù–∏–∫/–ò–º—è");
        lines.push("----------------------------------------");
        for(const p of sorted) lines.push(`${p.num} ${p.name}`);
        downloadText(lines.join("\n"), makeFileName("players","txt"));
      });

      btnImportPlayersTxt.addEventListener("click", ()=>{
        fileImportPlayers.value="";
        fileImportPlayers.click();
      });

      fileImportPlayers.addEventListener("change", async ()=>{
        const file = fileImportPlayers.files && fileImportPlayers.files[0];
        if(!file) return;
        const text = await file.text();
        const items = parseBulkLines(text);
        if(items.length===0){ alert("–§–∞–π–ª –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç: ‚Ññ –ù–∏–∫"); return; }
        let added=0, skipped=0;
        for(const it of items){
          if(state.players.some(p=>p.num===it.num)) skipped++;
          else { addPlayer(it.num, it.name); added++; }
        }
        saveState(); render();
        alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ: ${added}. –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skipped}.`);
      });

      // Import results TXT
      btnImportResultsTxt.addEventListener("click", ()=>{
        fileImportResults.value="";
        fileImportResults.click();
      });

      fileImportResults.addEventListener("change", async ()=>{
        const file = fileImportResults.files && fileImportResults.files[0];
        if(!file) return;
        const text = await file.text();
        importResultsFromTxt(text);
      });

      function importResultsFromTxt(text){
        const lines = text.split(/\r?\n/);
        const headerIdx = lines.findIndex(l => l.toLowerCase().includes("–º–µ—Å—Ç–æ") && l.includes("|") && l.toLowerCase().includes("–∏—Ç–æ–≥–æ"));
        if(headerIdx===-1){
          alert("–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ù—É–∂–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞: '–ú–ï–°–¢–û | ‚Ññ | ... | –ò–¢–û–ì–û'.");
          return;
        }
        const rows=[];
        for(let i=headerIdx+1;i<lines.length;i++){
          const line = lines[i].trim();
          if(!line || !line.includes("|")) continue;
          const parts = line.split("|").map(s=>s.trim());
          if(parts.length<9) continue;
          const place = parseInt(parts[0],10);
          const num = parseInt(parts[1],10);
          const name = parts[2] || `Player #${num}`;
          const ko = parseInt(parts[5],10) || 0;
          const koPoints = parseInt(parts[6],10) || 0;
          const placePoints = parseInt(parts[7],10) || 0;
          const totalPoints = parseInt(parts[8],10) || 0;
          if(!place || !num) continue;
          rows.push({place,num,name,ko,koPoints,placePoints,totalPoints});
        }
        if(rows.length===0){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."); return; }

        Object.assign(state, newState());
        state.finalized = true;

        for(const r of rows){
          addPlayer(r.num, r.name);
          const p = state.players.find(x=>x.num===r.num);
          p.ko=r.ko; p.koPoints=r.koPoints; p.placePoints=r.placePoints; p.totalPoints=r.totalPoints; p.place=r.place; p.status=2;
        }

        const others = rows.filter(r=>r.place!==1).sort((a,b)=>a.place-b.place);
        state.outCounter = others.length;
        let outIndex = others.length;
        for(const r of others){
          const p = state.players.find(x=>x.num===r.num);
          p.outIndex = outIndex--;
        }
        const win = rows.find(r=>r.place===1);
        if(win){
          const p = state.players.find(x=>x.num===win.num);
          p.outIndex = null;
        }

        // mark entries paid (simpler)
        for(const e of state.entries) e.status=2;

        saveState(); render();
        alert(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: ${rows.length} —Å—Ç—Ä–æ–∫(–∏).`);
      }

      // Search
      btnSearch.addEventListener("click", doSearch);
      searchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

      function doSearch(){
        const q=(searchInput.value||"").trim().toLowerCase();
        if(!q) return;
        let target=null;
        const num=parseInt(q,10);
        if(num) target = state.players.find(p=>p.num===num);
        if(!target) target = state.players.find(p=>(p.name||"").toLowerCase().includes(q));
        if(!target){ alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ."); return; }
        const row=document.querySelector(`tr[data-player-num="${target.num}"]`);
        if(row){
          row.scrollIntoView({behavior:"smooth", block:"center"});
          row.classList.add("flash");
          setTimeout(()=>row.classList.remove("flash"), 900);
        }
      }

      // Entries row tap
      entriesTbody.addEventListener("click", (e)=>{
        const tr=e.target.closest("tr");
        if(!tr) return;
        const id=tr.getAttribute("data-entry-id");
        const entry=state.entries.find(x=>x.id===id);
        if(!entry) return;

        entry.status = (entry.status+1)%3;

        // sync player for main entry
        if(entry.type==="entry"){
          const p=state.players.find(p=>p.num===entry.num);
          if(p) p.status = entry.status;
        }

        // if finalized and payment changed -> unfinalize to avoid wrong points
        if(state.finalized){
          state.finalized=false;
          btnExportResultsTxt.disabled=true;
          for(const p of state.players){
            p.place=null; p.placePoints=0; p.totalPoints=0;
          }
        }

        recomputeAllPoints(true);
        saveState(); render();
      });

      // Players row tap (ignore buttons/inputs)
      playersTbody.addEventListener("click", (e)=>{
        if(e.target.closest("button") || e.target.closest("input")) return;
        const tr=e.target.closest("tr");
        if(!tr) return;
        const num=parseInt(tr.getAttribute("data-player-num"),10);
        const p=state.players.find(x=>x.num===num);
        if(!p) return;

        p.status=(p.status+1)%3;

        // sync main entry status
        const main=state.entries.find(x=>x.num===p.num && x.type==="entry");
        if(main) main.status=p.status;

        if(state.finalized){
          state.finalized=false;
          btnExportResultsTxt.disabled=true;
          for(const pl of state.players){
            pl.place=null; pl.placePoints=0; pl.totalPoints=0;
          }
        }

        recomputeAllPoints(true);
        saveState(); render();
      });

      // Finalize / export / reset
      btnFinalize.addEventListener("click", finalizeTournament);

      btnExportResultsTxt.addEventListener("click", ()=>{
        const txt = buildResultsTxt();
        downloadText(txt, makeFileName("results","txt"));
      });

      btnReset.addEventListener("click", ()=>{
        if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) return;
        Object.assign(state, newState());
        syncModeUI();
        saveState(); render();
      });

      function countPaid(type){ return state.entries.filter(e=>e.type===type && e.status===2).length; }
      function countTotal(type){ return state.entries.filter(e=>e.type===type).length; }
      function computePoolPoints(){ return (countPaid("entry")+countPaid("re"))*ENTRY_POINTS; }

      function koPointsForPlayer(p){
        const ko=Math.max(0, parseInt(p.ko,10)||0);
        if(state.mode==="standard") return 0;
        if(state.mode==="cascade"){
          const per = (state.cascadePhase==="late") ? 50 : (state.cascadePhase==="after") ? 100 : 200;
          return ko*per;
        }
        // bloodhunter
        let pts=0;
        for(let i=1;i<=ko;i++){
          if(i===1) pts+=50;
          else if(i===2) pts+=75;
          else if(i===3) pts+=100;
          else pts+=150;
        }
        return pts;
      }

      function recomputeAllPoints(keepPlace){
        for(const p of state.players){
          p.ko = Math.max(0, parseInt(p.ko,10)||0);
          p.koPoints = koPointsForPlayer(p);
          if(!keepPlace && !state.finalized){
            p.placePoints=0; p.place=null;
          }
          p.totalPoints = (p.placePoints||0) + (p.koPoints||0);
        }
      }

      function finalizeTournament(){
        const alive = state.players.filter(p=>p.outIndex==null);
        if(alive.length!==1){
          alert("–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ä–æ–≤–Ω–æ 1 –∏–≥—Ä–æ–∫ ¬´–≤ –∏–≥—Ä–µ¬ª. –û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ª–µ—Ç—ã –∫–Ω–æ–ø–∫–æ–π ¬´–ê–£–¢¬ª.");
          return;
        }

        const pool = computePoolPoints();
        const winner=alive[0];

        const out = state.players
          .filter(p=>p.outIndex!=null)
          .sort((a,b)=> (b.outIndex-a.outIndex)); // last eliminated first

        winner.place=1;
        let place=2;
        for(const p of out){ p.place=place++; }

        for(const p of state.players){
          if(p.place && p.place>=1 && p.place<=18){
            const percent = TOP18_PERCENTS[p.place-1]/100;
            p.placePoints = Math.round(pool*percent);
          }else{
            p.placePoints=0;
          }
        }

        recomputeAllPoints(true);
        state.finalized=true;
        btnExportResultsTxt.disabled=false;

        saveState(); render();
        alert("–¢—É—Ä–Ω–∏—Ä –∑–∞–≤–µ—Ä—à—ë–Ω. –û—á–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã. –ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (.txt).");
      }

      function buildResultsTxt(){
        const pool=computePoolPoints();
        const paidEntry=countPaid("entry");
        const paidRe=countPaid("re");
        const modeLabel = state.mode==="standard" ? "–û–±—ã—á–Ω—ã–π" : state.mode==="cascade" ? "CASCADE K.O." : "BLOOD HUNTER K.O.";
        const phaseLabel = state.cascadePhase==="late" ? "–î–æ –∫–æ–Ω—Ü–∞ –ø–æ–∑–¥–Ω–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (+50 –∑–∞ KO)"
                        : state.cascadePhase==="after" ? "–ü–æ—Å–ª–µ –ø–æ–∑–¥–Ω–µ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (+100 –∑–∞ KO)"
                        : "–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª (+200 –∑–∞ KO)";

        const lines=[];
        lines.push("ALL IN CAPONE CLUB");
        lines.push("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–£–†–ù–ò–†–ê");
        lines.push("");
        lines.push(`–¢–∏–ø —Ç—É—Ä–Ω–∏—Ä–∞: ${modeLabel}`);
        if(state.mode==="cascade") lines.push(`–§–∞–∑–∞: ${phaseLabel}`);
        lines.push("");
        lines.push("–ü—É–ª –æ—á–∫–æ–≤:");
        lines.push("(–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã + –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ re-entry) √ó 120");
        lines.push(`(${paidEntry} + ${paidRe}) √ó 120 = ${pool}`);
        lines.push("");
        lines.push("----------------------------------------");
        lines.push("");
        lines.push("–ú–ï–°–¢–û | ‚Ññ | –ù–ò–ö | ENTRY | RE | KO | –û–ß–ö–ò KO | –û–ß–ö–ò –ó–ê –ú–ï–°–¢–û | –ò–¢–û–ì–û");

        const rows=[...state.players].filter(p=>p.place!=null).sort((a,b)=>a.place-b.place);

        for(const p of rows){
          const entryAll = state.entries.filter(e=>e.num===p.num && e.type==="entry").length;
          const reAll = state.entries.filter(e=>e.num===p.num && e.type==="re").length;
          const entryPaid = state.entries.filter(e=>e.num===p.num && e.type==="entry" && e.status===2).length;
          const rePaid = state.entries.filter(e=>e.num===p.num && e.type==="re" && e.status===2).length;

          lines.push([
            p.place,
            p.num,
            p.name,
            `${entryPaid}/${entryAll}`,
            `${rePaid}/${reAll}`,
            p.ko||0,
            p.koPoints||0,
            p.placePoints||0,
            p.totalPoints||0
          ].join(" | "));
        }
        return lines.join("\n");
      }

      function render(){
        syncModeUI();

        // stats (IMPORTANT: no 0/0 here)
        const pool = computePoolPoints();
        const entriesAll = countTotal("entry");
        const reAll = countTotal("re");

        statPool.textContent = String(pool);
        statEntries.textContent = String(entriesAll);
        statRe.textContent = String(reAll);
        statTotal.textContent = String(entriesAll + reAll);

        statFormula.textContent =
          `(–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã + –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ re-entry) √ó 120 = (${countPaid("entry")} + ${countPaid("re")}) √ó 120 = ${pool}`;

        renderEntries();
        renderPlayers();

        btnExportResultsTxt.disabled = !state.finalized;

        saveState();
      }

      function renderEntries(){
        const playersMap = new Map(state.players.map(p=>[p.num,p]));
        const rows=[...state.entries].sort((a,b)=>{
          if(a.num!==b.num) return a.num-b.num;
          if(a.type!==b.type) return (a.type==="entry") ? -1 : 1;
          return a.id.localeCompare(b.id);
        });

        entriesTbody.innerHTML="";
        for(const e of rows){
          const p=playersMap.get(e.num);
          const tr=document.createElement("tr");
          tr.setAttribute("data-entry-id", e.id);
          tr.innerHTML=`
            <td>${e.num}</td>
            <td>${escapeHtml(p ? p.name : ("Player #"+e.num))}</td>
            <td>${e.type==="entry" ? "–≤—Ö–æ–¥" : "re-entry"}</td>
            <td><span class="pill">${ENTRY_STATUS_LABEL(e.status)}</span></td>
          `;
          entriesTbody.appendChild(tr);
        }
      }

      function renderPlayers(){
        const alive = state.players.filter(p=>p.outIndex==null).sort((a,b)=>a.num-b.num);
        const out = state.players.filter(p=>p.outIndex!=null).sort((a,b)=> (b.outIndex-a.outIndex));
        const ordered=[...alive, ...out];

        playersTbody.innerHTML="";

        for(const p of ordered){
          const tr=document.createElement("tr");
          tr.setAttribute("data-player-num", p.num);
          if(p.outIndex!=null) tr.classList.add("outRow");

          const statusText = (p.outIndex!=null) ? "–∞—É—Ç" : PLAYER_STATUS_LABEL(p.status);
          const statusClass = (p.outIndex!=null) ? "pillOut" : (p.status===2 ? "pillPaid" : (p.status===1 ? "pillCome" : ""));

          const itogo = state.finalized ? (p.totalPoints||0) : (p.koPoints||0);
          const breakdown = state.finalized
            ? `<div style="color:var(--muted);font-size:11px;margin-top:2px;">KO: ${p.koPoints||0} ¬∑ –º–µ—Å—Ç–æ: ${p.placePoints||0}${p.place?` ¬∑ #${p.place}`:""}</div>`
            : `<div style="color:var(--muted);font-size:11px;margin-top:2px;">KO-–æ—á–∫–∏ —Å–µ–π—á–∞—Å ¬∑ –º–µ—Å—Ç–æ ‚Äî –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>`;

          const outBtnLabel = (p.outIndex==null) ? "–ê–£–¢" : "–û—Ç–º–µ–Ω–∞ –ê–£–¢";

          tr.innerHTML=`
            <td>${p.num}</td>
            <td>${escapeHtml(p.name)}</td>
            <td><span class="pill ${statusClass}">${statusText}</span></td>
            <td><input class="koInput" type="number" min="0" value="${p.ko||0}" data-ko-num="${p.num}"></td>
            <td>
              <div style="font-weight:900;color:var(--gold);">${itogo}</div>
              ${breakdown}
            </td>
            <td>
              <div class="miniBtns">
                <button class="miniBtn" data-action="re" data-num="${p.num}">Re-entry +</button>
                <button class="miniBtn" data-action="out" data-num="${p.num}">${outBtnLabel}</button>
                <button class="miniBtn miniBtnDanger" data-action="del" data-num="${p.num}">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </td>
          `;
          playersTbody.appendChild(tr);
        }

        // KO inputs: stop row-tap
        playersTbody.querySelectorAll('input[data-ko-num]').forEach(inp=>{
          inp.addEventListener("click", e=>e.stopPropagation());
          inp.addEventListener("input", e=>{
            e.stopPropagation();
            const num=parseInt(inp.getAttribute("data-ko-num"),10);
            const p=state.players.find(x=>x.num===num);
            if(!p) return;
            p.ko = Math.max(0, parseInt(inp.value,10)||0);
            recomputeAllPoints(true);
            saveState(); render();
          });
        });

        // Mini buttons
        playersTbody.querySelectorAll('button[data-action]').forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            e.stopPropagation();
            const action=btn.getAttribute("data-action");
            const num=parseInt(btn.getAttribute("data-num"),10);
            const p=state.players.find(x=>x.num===num);
            if(!p) return;

            if(action==="re"){
              state.entries.push({ id:uid(), num:p.num, type:"re", status:0 });
              if(state.finalized){ unfinalize(); }
            }
            if(action==="out"){
              if(p.outIndex==null){ state.outCounter+=1; p.outIndex=state.outCounter; }
              else p.outIndex=null;
              if(state.finalized){ unfinalize(); }
            }
            if(action==="del"){
              if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ #${p.num} (${p.name})?`)) return;
              state.players = state.players.filter(x=>x.num!==p.num);
              state.entries = state.entries.filter(en=>en.num!==p.num);
              if(state.finalized){ unfinalize(); }
            }

            recomputeAllPoints(true);
            saveState(); render();
          });
        });
      }

      function unfinalize(){
        state.finalized=false;
        btnExportResultsTxt.disabled=true;
        for(const pl of state.players){
          pl.place=null; pl.placePoints=0; pl.totalPoints=0;
        }
      }

      // Helpers
      function downloadText(text, filename){
        const blob=new Blob([text], {type:"text/plain;charset=utf-8"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download=filename;
        document.body.appendChild(a);
        a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 3000);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function makeFileName(prefix, ext){
        const d=new Date();
        return `${prefix}_${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}.${ext}`;
      }
      function escapeHtml(str){
        return String(str)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // init
      syncModeUI();
      recomputeAllPoints(true);
      render();
      saveState();

      // ESC closes modal
      document.addEventListener("keydown", (e)=>{
        if(e.key==="Escape" && modalOverlay.style.display==="flex") openModal(false);
      });
    })();
  </script>
</body>
</html>
